<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TTY Art Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0e0f12; --panel:#16181d; --ink:#e6e7eb; --muted:#9aa0a6; --accent:#7aa2ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink); }
    header { padding:16px 20px; border-bottom:1px solid #222833; background:linear-gradient(180deg,#12141a,#0e0f12); position:sticky; top:0; }
    h1 { margin:0; font-size:20px; letter-spacing:.3px; }
    .wrap { padding:12px; display:grid; grid-template-columns: 420px 1fr; gap:12px; }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }
    .card { background:var(--panel); border:1px solid #222833; border-radius:14px; padding:12px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }
    input[type="number"], input[type="text"], select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040; background:#0f1116; color:var(--ink); }
    button { padding:10px 12px; border-radius:10px; border:1px solid #2a3040; background:#0f1116; color:var(--ink); cursor:pointer; }
    button.primary { background:var(--accent); color:#0b0c10; border-color:#2c3e89; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px; }
    .status { color:var(--muted); font-size:12px; margin-top:6px; min-height:18px; }
    .list { max-height:48vh; overflow:auto; border-top:1px dashed #2a3040; margin-top:8px; padding-top:8px; }
    .preview { max-height:48vh; overflow:auto; border-top:1px dashed #2a3040; margin-top:8px; padding-top:8px; }
    .art-head { display:flex; align-items:center; gap:8px; font-size:13px; margin-top:4px; }
    .art-pre { white-space: pre; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; line-height:1.12; background:#0b0c10; color:#cfe3ff; border:1px solid #2a3040; border-radius:10px; padding:8px; max-height:32vh; overflow:auto; margin:6px 0 12px; }
    audio { width:100%; margin-top:10px; }
    .muted { color:var(--muted); }
    .links a{ display:inline-block; margin:6px 8px 0 0; }
    pre.testlog { background:#0b0c10; color:#c4d2ff; padding:10px; border-radius:10px; border:1px dashed #2a3040; max-height:32vh; overflow:auto; }

    /* Disclaimer */
    .disclaimer{
      margin:12px 12px 0;
      background:linear-gradient(180deg,#141a26,#101521);
      border:1px solid #2f3a52;
      border-left:8px solid #ffc107; /* attention yellow */
      padding:16px 56px 16px 56px; /* extra left for icon, right for close */
      border-radius:14px;
      font-size:15px;
      line-height:1.45;
      color:var(--ink);
      position:relative;
      box-shadow:0 10px 24px rgba(0,0,0,.4), inset 0 0 0 1px rgba(255,193,7,.08);
    }
    .disclaimer .close{
      position:absolute; right:12px; top:10px;
      background:none; border:none; color:var(--muted);
      cursor:pointer; font-size:18px; line-height:1; padding:4px; border-radius:8px;
    }

    /* Extra disclaimer rules */
    .disclaimer::before{ content:'⚠️'; position:absolute; left:16px; top:12px; transform:none; font-size:22px; filter:drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
    .disclaimer strong{ font-weight:800; font-size:16px; letter-spacing:.2px; }
    .disclaimer .close:hover{ background:rgba(255,255,255,0.04); }

    /* NSFW modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal.show{ display:flex; }
    .modal-card{ background:var(--panel); border:1px solid #2a3040; border-radius:14px; padding:16px; width:min(560px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .modal .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
  </style>
</head>
<body>
  <header>
    <h1>TTY Art Feed</h1>
  </header>

  <div id="disclaimer" class="disclaimer" role="note" aria-live="polite">
    <button id="discClose" class="close" aria-label="Dismiss disclaimer">✕</button>
    <strong>Disclaimer:</strong> This app aggregates vintage RTTY art from third‑party sources. Some pieces may be insensitive or politically incorrect. I’ve done my best to filter NSFW, but there are no guarantees; viewer discretion is advised.
    <br/>
    <span class="muted">Views and opinions expressed in the sourced artwork are those of the original creators and do not necessarily reflect my views. I do not endorse or take responsibility for any messages, symbols, or depictions shown.</span>
  </div>

  <!-- About & Instructions -->
  <div id="about" class="card" style="margin:12px">
    <h2 style="margin:0 0 6px">About & Instructions</h2>
    <p style="margin:6px 0 10px; color:var(--ink)">I built this to make it easy to preview and stream <b>vintage RTTY/TTY art</b> as AFSK audio for hardware TTY gear or software decoders, and to help preserve and share this slice of computing/radio history. All artwork is sourced from the excellent <a href="http://artscene.textfiles.com/rtty/COLLECTION/" target="_blank" rel="noopener">TEXTFILES.COM Artscene RTTY Collection</a> — huge credit to the collectors and curators who archived it.</p>
    <ol style="margin:0 0 10px 18px; padding:0; color:var(--muted)">
      <li>Choose an <b>Art set</b> and <b>Content filter</b> (SFW excludes 04/07/08 and anything in your <code>nsfw_list.json</code>).</li>
      <li>Set AFSK params: <b>Baud</b>, <b>Mark</b>, <b>Space</b>, <b>Stop bits</b>. Default is 45.45 baud, 2125/2295 Hz, 1.5 stop bits.</li>
      <li>Optionally set a <b>Mark lead‑in</b> (sec) to wake auto‑start decoders before each piece.</li>
      <li>Pick how many items to include, the <b>gap</b> (minutes) between pieces, and the <b>time limits</b> / <b>split</b> size (minutes per WAV).</li>
      <li>Click <b>Build WAV</b>. A preview of each piece appears on the right; downloads for each segment show below the player.</li>
    </ol>
    <p class="muted" style="margin:0">Advanced: place your bundled files under <code>rtty_offline/</code> with a <code>manifest.json</code> of paths like <code>ARTWORK-01/000</code>. Add a manual NSFW override list at <code>rtty_offline/nsfw_list.json</code> (JSON array or newline list). This project is unaffiliated with the archive and is provided for educational/historic purposes.</p>
  </div>

  <div id="nsfwModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 style="margin:0 0 8px">NSFW content</h3>
      <p class="muted">NSFW mode may include nudity or adult content from ARTWORK-04, ARTWORK-07, and ARTWORK-08. Continue?</p>
      <div class="actions">
        <button id="nsfwCancel">Cancel</button>
        <button id="nsfwEnable" class="primary">Enable NSFW</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label>Count (artworks)</label>
          <input id="count" type="number" value="25" min="1" max="500" />
        </div>
        <div>
          <label>Gap between pieces (min)</label>
          <input id="gap" type="number" value="2" min="0" step="0.1" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Mark lead‑in (sec)</label>
          <input id="leadSec" type="number" value="5" min="0" step="0.5" />
        </div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>Art set</label>
          <select id="artSet">
            <option value="all" selected>All (01–08)</option>
            <option value="cartoons">Cartoons (ARTWORK-01)</option>
            <option value="sports_portraits">Sports &amp; Portraits (ARTWORK-02)</option>
            <option value="holidays">Holidays (ARTWORK-03)</option>
            <option value="nsfw_women">NSFW Women (ARTWORK-04)</option>
            <option value="symbols_buildings_scouts_homilies">Symbols, Buildings, Scouts, Homilies (ARTWORK-05)</option>
            <option value="space_flags_slogans_portraits">Space, Flags, Slogans, Portraits (ARTWORK-06)</option>
            <option value="characters_pinups_slogans_starwars">NSFW Characters, Pinups, Slogans, Star Wars (ARTWORK-07)</option>
            <option value="characters_space_slogans">NSFW Characters, Space, Slogans (ARTWORK-08)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>Content filter</label>
          <select id="nsfwMode">
            <option value="sfw" selected>SFW (exclude ARTWORK-04, -07, -08 and NSFW List)</option>
            <option value="nsfw">NSFW (includes all collections)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="row">
        <div>
          <label>Baud Rate</label>
          <input id="baudRate" type="number" value="45.45" step="0.01" />
        </div>
        <div>
          <label>Stop Bits</label>
          <input id="stopBits" type="number" value="1.5" step="0.1" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Mark Frequency (Hz)</label>
          <input id="markFreq" type="number" value="2125" />
        </div>
        <div>
          <label>Space Frequency (Hz)</label>
          <input id="spaceFreq" type="number" value="2295" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Max minutes / item (0 = no per-item limit; may split mid‑piece)</label>
          <input id="maxMinItem" type="number" value="0" min="0" step="0.5" />
        </div>
        <div>
          <label>Max minutes total</label>
          <input id="maxMinTotal" type="number" value="1440" min="1" step="1" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Split every (minutes per file)</label>
          <input id="splitMin" type="number" value="1440" min="1" step="1" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="buildBtn" class="primary" style="width:100%">Build WAV</button>
        </div>
      </div>

      <div id="status" class="status">idle</div>
      <audio id="player" controls></audio>
      <div id="downloadWrap" class="status links"></div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button id="testBtn">Run self-test</button>
        <span class="muted">(verifies Baudot, AFSK, streaming & WAV header)</span>
      </div>
      <pre id="testLog" class="testlog" style="display:none"></pre>
    </div>

    <div class="card">
      <div><b>Preview (randomized selection)</b> <span class="muted" id="countInfo"></span></div>
      <div id="preview" class="preview"></div>
    </div>
  </div>

  <!-- Footer / credit / license -->
  <footer style="margin:12px; text-align:left;">
    <img src="logo.png" alt="Logo" style="height:75px; width:auto; display:block; margin-bottom:6px;">
    <p style="font-size:0.8em; color:#888; margin:0;">
      © 2025 Frankie Caswell — UI Licensed under
      <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>.
    </p>
  </footer>

  <!-- Hidden canvas (safe to include even if unused) -->
  <canvas id="asciiCanvas" style="display:none"></canvas>

  <!-- GoatCounter analytics -->
  <script data-goatcounter="https://unluckyfett.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  
<script>
(function(){
  'use strict';

  /* ---- Minimal Set polyfill for tests (if needed) ---- */
  if (typeof window.Set === 'undefined'){
    window.Set = function(arr){ this._m = {}; if (arr){ for (var i=0;i<arr.length;i++){ this._m[arr[i]] = true; } } }; 
    window.Set.prototype.add = function(v){ this._m[v]=true; return this; };
    window.Set.prototype.has = function(v){ return !!this._m[v]; };
  }

  // ====== Surface runtime errors ======
  addEventListener('error', function(e){
    var el = document.getElementById('status');
    if (el) el.textContent = 'JS error: ' + (e.message || (e.error && e.error.message) || e);
  });
  addEventListener('unhandledrejection', function(e){
    var el = document.getElementById('status');
    if (el) el.textContent = 'Promise error: ' + (e.reason && (e.reason.message||e.reason));
  });

  // ====== UI refs ======
  var els = {
    buildBtn: document.getElementById('buildBtn'),
    status: document.getElementById('status'),
    player: document.getElementById('player'),
    preview: document.getElementById('preview'),
    countInfo: document.getElementById('countInfo'),
    downloadWrap: document.getElementById('downloadWrap'),
    baud: document.getElementById('baudRate'),
    stopBits: document.getElementById('stopBits'),
    mark: document.getElementById('markFreq'),
    space: document.getElementById('spaceFreq'),
    count: document.getElementById('count'),
    gap: document.getElementById('gap'),
    leadSec: document.getElementById('leadSec'),
    testBtn: document.getElementById('testBtn'),
    testLog: document.getElementById('testLog'),
    nsfwMode: document.getElementById('nsfwMode'),
    nsfwModal: document.getElementById('nsfwModal'),
    nsfwEnable: document.getElementById('nsfwEnable'),
    nsfwCancel: document.getElementById('nsfwCancel'),
    artSet: document.getElementById('artSet')
  };
  var setStatus = function(s){ els.status.textContent = s; };

  // ====== Disclaimer banner (always show on refresh; no persistence) ======
  (function(){
    var d = document.getElementById('disclaimer');
    var b = document.getElementById('discClose');
    if (b){ b.addEventListener('click', function(){ if (d) d.style.display='none'; }); }
    // Ensure visible on load in case it was previously hidden
    if (d) d.style.display = '';
  })();

  // ====== Preview builder ======
  function renderPreviews(picks){
    var wrap = els.preview; if (!wrap) return; wrap.innerHTML = '';
    for (var i=0;i<picks.length;i++){
      (function(p){
        var sec = document.createElement('section');
        var head = document.createElement('div'); head.className = 'art-head';
        var a = document.createElement('a');
        var href = bundled.base ? (bundled.base + '/' + p.pagePath) : p.pagePath;
        a.href = href; a.target = '_blank'; a.rel = 'noopener'; a.textContent = p.dir + '/' + p.filename;
        head.appendChild(a);
        var pre = document.createElement('pre'); pre.className = 'art-pre'; pre.textContent = '…loading…';
        sec.appendChild(head); sec.appendChild(pre); wrap.appendChild(sec);
        fetchArtTextBundled(p.pagePath)
          .then(function(raw){ var txt = normalizeText(raw||''); p.normalizedText = txt; pre.textContent = txt || '(empty)'; })
          .catch(function(){ pre.textContent = '(load error)'; });
      })(picks[i]);
    }
  }

  // ====== NSFW toggle (custom modal) ======
  (function(){
    var sel = els.nsfwMode;
    var modal = els.nsfwModal, btnOk = els.nsfwEnable, btnCancel = els.nsfwCancel;
    function showModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
    function hideModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    sel.addEventListener('change', function(){ if (sel.value === 'nsfw'){ showModal(); } });
    btnCancel.addEventListener('click', function(){ hideModal(); sel.value = 'sfw'; });
    btnOk.addEventListener('click', function(){ hideModal(); /* keep nsfw */ });
    modal.addEventListener('click', function(e){ if (e.target === modal){ hideModal(); sel.value = 'sfw'; } });
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && modal.classList.contains('show')){ hideModal(); sel.value='sfw'; } });
  })();

  // ====== Bundled manifest (no remote/proxy UI) ======
  var MANIFEST_URL = 'rtty_offline/manifest.json';
  var bundled = { base:'', items:[], loaded:false };

  function deriveBaseFromUrl(url){
    var slash = url.lastIndexOf('/');
    return slash >= 0 ? url.slice(0, slash) : '';
  }

  function loadManifest(){
    return fetch(MANIFEST_URL, { cache:'no-cache' })
      .then(function(res){ if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); })
      .then(function(json){
        var base='', items=[];
        if (Array.isArray(json)){
          items = json.slice();
          base = deriveBaseFromUrl(MANIFEST_URL);
        } else if (json && Array.isArray(json.items)){
          items = json.items.slice();
          base = (json.base || '').trim() || deriveBaseFromUrl(MANIFEST_URL);
        } else {
          for (var k in (json||{})){
            if (!Object.prototype.hasOwnProperty.call(json,k)) continue;
            var arr = json[k];
            if (Array.isArray(arr)) for (var i=0;i<arr.length;i++) items.push(k + '/' + arr[i]);
          }
          base = (json.base || '').trim() || deriveBaseFromUrl(MANIFEST_URL);
        }
        items = items.filter(function(x){ return /^(ARTWORK-0[1-8])\/([0-9]{3})$/.test(x); });
        if (!items.length) throw new Error('manifest had no valid items');
        bundled.base = base; bundled.items = items; bundled.loaded = true; return true;
      })
      .catch(function(e){ bundled.base=''; bundled.items=[]; bundled.loaded=false; setStatus('manifest load failed: '+(e.message||e)); return false; });
  }

  function fetchArtTextBundled(rel){
    var url = (bundled.base ? (bundled.base + '/') : '') + rel;
    return fetch(url, { cache:'no-cache' })
      .then(function(r){ return r.ok ? r.text() : ''; })
      .then(function(txt){ return normalizeCRLF(txt); })
      .catch(function(){ return ''; });
  }

  var NSFW_LIST_URL = 'rtty_offline/nsfw_list.json'; // optional JSON or newline list of ARTWORK-xx/nnn
  var nsfwOverrides = { map: Object.create(null), loaded:false };
  function parseNsfwList(txt){
    if (!txt) return Object.create(null);
    var arr = [];
    try {
      var j = JSON.parse(txt);
      if (Array.isArray(j)) arr = j;
      else if (j && Array.isArray(j.items)) arr = j.items;
    } catch(e){
      arr = txt.split(/\r?\n/);
    }
    var m = Object.create(null);
    for (var i=0;i<arr.length;i++){
      var s = (arr[i]||'').trim();
      if (!s) continue;
      if (!/^(ARTWORK-0[1-8])\/([0-9]{3})$/.test(s)) continue;
      m[s] = 1;
    }
    return m;
  }
  function loadNsfwOverrides(){
    return fetch(NSFW_LIST_URL, { cache:'no-cache' })
      .then(function(res){ if(!res.ok) throw new Error('http '+res.status); return res.text(); })
      .then(function(txt){ nsfwOverrides.map = parseNsfwList(txt); nsfwOverrides.loaded=true; return true; })
      .catch(function(){ nsfwOverrides.map = Object.create(null); nsfwOverrides.loaded=true; return false; });
  }
  function isSfwAllowed(x){
    if (nsfwOverrides.map && nsfwOverrides.map[x]) return false; // explicit overrides
    return !(x.indexOf('ARTWORK-04/')===0 || x.indexOf('ARTWORK-07/')===0 || x.indexOf('ARTWORK-08/')===0);
  }

  function isInSelectedSet(x){
    var v = (els.artSet && els.artSet.value) || 'all';
    if (v === 'all') return true;
    var map = {
      cartoons:'ARTWORK-01/',
      sports_portraits:'ARTWORK-02/',
      holidays:'ARTWORK-03/',
      nsfw_women:'ARTWORK-04/',
      symbols_buildings_scouts_homilies:'ARTWORK-05/',
      space_flags_slogans_portraits:'ARTWORK-06/',
      characters_pinups_slogans_starwars:'ARTWORK-07/',
      characters_space_slogans:'ARTWORK-08/'
    };
    var pre = map[v];
    return pre ? x.indexOf(pre)===0 : true;
  }

  function ensureLoaded(){
    var p = Promise.resolve(true);
    if (!bundled.loaded) p = p.then(loadManifest); else p = p.then(function(){ return true; });
    return p.then(function(ok){ if (!ok) return false; if (!nsfwOverrides.loaded) return loadNsfwOverrides().then(function(){return true;}); return true; });
  }

  function sampleRandomArt(n){
    function pick(){
      var mode = (els.nsfwMode && els.nsfwMode.value) || 'sfw';
      var pool = bundled.items.slice();
      pool = pool.filter(isInSelectedSet);
      if (mode !== 'nsfw') pool = pool.filter(isSfwAllowed);
      if (!pool.length) return [];
      var seen = Object.create(null); var out = []; var attempts=0, maxAttempts=n*20;
      while (out.length<n && attempts++<maxAttempts){
        var item = pool[(Math.random()*pool.length)|0];
        if (seen[item]) continue; seen[item] = 1;
        var parts = item.split('/');
        out.push({ dir: parts[0], filename: parts[1], pagePath: item });
      }
      return out;
    }
    if (!bundled.loaded || !nsfwOverrides.loaded){
      return ensureLoaded().then(function(ok){ return ok ? pick() : []; });
    }
    return Promise.resolve(pick());
  }

  // ====== Newline helpers ======
  var CR = String.fromCharCode(13);
  var LF = String.fromCharCode(10);
  function normalizeCRLF(s){
    // Replace bare CR with CRLF; leave existing CRLF intact.
    var re = new RegExp(CR + '(?!' + LF + ')', 'g');
    return (s || '').replace(re, CR + LF);
  }

  // ====== BAUDOT / AFSK ======
  var printableSet = "#ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789:;.,-'()/&$?! ";
  var replacementMap = (function(){
    var m = {
      '"':"'", '=':'-', '*':'X', '_':'-', '@':'A', '%':'O',
      '[':'(', ']':')', '{':'(', '}':')', '^':'-', '|':'/',
      '`':"'", '~':'-', '<':'(', '>':')'
    };
    m[String.fromCharCode(92)] = '/'; // backslash
    return m;
  })();
  function normalizeChar(ch){
    if (ch === CR || ch === LF) return ch; // keep CR/LF
    var u = (ch||'').toUpperCase();
    var safe = replacementMap[u] || replacementMap[ch] || u;
    return printableSet.indexOf(safe) !== -1 ? safe : ' ';
  }
  function splitByCodePoint(s){
    var out=[], i=0, n = s ? s.length : 0;
    for (; i<n; i++){
      var c = s.charCodeAt(i);
      if (c>=0xD800 && c<=0xDBFF && i+1<n){
        var c2 = s.charCodeAt(i+1);
        if (c2>=0xDC00 && c2<=0xDFFF){ out.push(s.substr(i,2)); i++; continue; }
      }
      out.push(s.charAt(i));
    }
    return out;
  }
  function normalizeText(s){
    var arr = splitByCodePoint(s || '');
    for (var i=0;i<arr.length;i++){ arr[i] = normalizeChar(arr[i]); }
    return arr.join('');
  }

  // Use decimals (ES5-safe) for ITA2 codes
  var LTRS = 31, FIGS = 27; // 0b11111, 0b11011
  var BAUDOT_TABLE = { LTRS: {}, FIGS: {} };
  // LTRS
  BAUDOT_TABLE.LTRS['A']=3;  BAUDOT_TABLE.LTRS['B']=25; BAUDOT_TABLE.LTRS['C']=14; BAUDOT_TABLE.LTRS['D']=9;  BAUDOT_TABLE.LTRS['E']=1;
  BAUDOT_TABLE.LTRS['F']=13; BAUDOT_TABLE.LTRS['G']=26; BAUDOT_TABLE.LTRS['H']=20; BAUDOT_TABLE.LTRS['I']=6;  BAUDOT_TABLE.LTRS['J']=11;
  BAUDOT_TABLE.LTRS['K']=15; BAUDOT_TABLE.LTRS['L']=18; BAUDOT_TABLE.LTRS['M']=28; BAUDOT_TABLE.LTRS['N']=12; BAUDOT_TABLE.LTRS['O']=24;
  BAUDOT_TABLE.LTRS['P']=22; BAUDOT_TABLE.LTRS['Q']=23; BAUDOT_TABLE.LTRS['R']=10; BAUDOT_TABLE.LTRS['S']=5;  BAUDOT_TABLE.LTRS['T']=16;
  BAUDOT_TABLE.LTRS['U']=7;  BAUDOT_TABLE.LTRS['V']=30; BAUDOT_TABLE.LTRS['W']=19; BAUDOT_TABLE.LTRS['X']=29; BAUDOT_TABLE.LTRS['Y']=21;
  BAUDOT_TABLE.LTRS['Z']=17; BAUDOT_TABLE.LTRS[CR]=8;  BAUDOT_TABLE.LTRS[LF]=2;  BAUDOT_TABLE.LTRS[' ']=4;
  // FIGS
  BAUDOT_TABLE.FIGS['-']=3;  BAUDOT_TABLE.FIGS['?']=25; BAUDOT_TABLE.FIGS[':']=14; BAUDOT_TABLE.FIGS['$']=9;  BAUDOT_TABLE.FIGS['3']=1;
  BAUDOT_TABLE.FIGS['!']=13; BAUDOT_TABLE.FIGS['&']=26; BAUDOT_TABLE.FIGS['#']=20; BAUDOT_TABLE.FIGS['8']=6;  BAUDOT_TABLE.FIGS["'"]=11;
  BAUDOT_TABLE.FIGS['(']=15; BAUDOT_TABLE.FIGS[')']=18; BAUDOT_TABLE.FIGS['.']=28; BAUDOT_TABLE.FIGS[',']=12; BAUDOT_TABLE.FIGS['9']=24;
  BAUDOT_TABLE.FIGS['0']=22; BAUDOT_TABLE.FIGS['1']=23; BAUDOT_TABLE.FIGS['4']=10; BAUDOT_TABLE.FIGS['Bell']=5; BAUDOT_TABLE.FIGS['5']=16;
  BAUDOT_TABLE.FIGS['7']=7;  BAUDOT_TABLE.FIGS[';']=30; BAUDOT_TABLE.FIGS['2']=19; BAUDOT_TABLE.FIGS['/']=29; BAUDOT_TABLE.FIGS['6']=21;
  BAUDOT_TABLE.FIGS['+']=17; BAUDOT_TABLE.FIGS[CR]=8; BAUDOT_TABLE.FIGS[LF]=2; BAUDOT_TABLE.FIGS[' ']=4;

  // Guard/timing constants for frame builder
  var GUARD_SHIFT_BITS = 0.0, GUARD_CR_BITS = 0.0, GUARD_LF_BITS = 0.0, LINE_LEAD_MS = 0, START_LEAD_MS = 0;

  // Build ITA2 (Baudot) frames from normalized text
  function buildBaudotFramesFromText(text){
    var frames=[]; var currentShift=null; var lastWasCR=false;
    // Minimal initial sync
    frames.push({type:'char', code: BAUDOT_TABLE.LTRS[CR], guardBits: GUARD_CR_BITS});
    frames.push({type:'char', code: BAUDOT_TABLE.LTRS[LF], guardBits: GUARD_LF_BITS});
    frames.push({type:'char', code: LTRS, guardBits: GUARD_SHIFT_BITS});
    if (START_LEAD_MS>0) frames.push({type:'hold', sec: START_LEAD_MS/1000});
    var t = text || '';
    for (var idx=0; idx < t.length; idx++){
      var raw = t.charAt(idx);
      var ch = normalizeChar(raw);
      if (ch===CR){ frames.push({type:'char', code: BAUDOT_TABLE.LTRS[CR], guardBits: GUARD_CR_BITS}); lastWasCR=true; continue; }
      if (ch===LF){ if (!lastWasCR) frames.push({type:'char', code: BAUDOT_TABLE.LTRS[CR], guardBits: GUARD_CR_BITS}); frames.push({type:'char', code: BAUDOT_TABLE.LTRS[LF], guardBits: GUARD_LF_BITS}); lastWasCR=false; if (LINE_LEAD_MS>0) frames.push({type:'hold', sec: LINE_LEAD_MS/1000}); continue; }
      lastWasCR=false; var needed=null;
      if (Object.prototype.hasOwnProperty.call(BAUDOT_TABLE.LTRS, ch)) needed='LTRS'; else if (Object.prototype.hasOwnProperty.call(BAUDOT_TABLE.FIGS, ch)) needed='FIGS'; else continue;
      if (needed!==currentShift){ frames.push({type:'char', code: (needed==='LTRS'?LTRS:FIGS), guardBits: GUARD_SHIFT_BITS}); currentShift=needed; }
      frames.push({type:'char', code: BAUDOT_TABLE[needed][ch]});
    }
    if (currentShift!=='LTRS') frames.push({type:'char', code: LTRS, guardBits: GUARD_SHIFT_BITS});
    frames.push({type:'char', code: BAUDOT_TABLE.LTRS[CR], guardBits: GUARD_CR_BITS});
    frames.push({type:'char', code: BAUDOT_TABLE.LTRS[LF], guardBits: GUARD_LF_BITS});
    return frames;
  }

  var DEFAULT_STRETCH = 1.002;

  // Sample rate helper (prefers AudioContext, falls back to 48 kHz)
  var audioCtx;
  function getSampleRate(){
    try{
      if (!audioCtx){
        var Ctx = window.AudioContext || window.webkitAudioContext;
        if (Ctx) audioCtx = new Ctx();
      }
      var sr = audioCtx && (audioCtx.sampleRate|0);
      if (sr && sr>=8000 && sr<=192000) return sr;
    }catch(e){}
    return 48000;
  }

  // Streamed AFSK generator -> Int16 chunks
  function afskStream(frames, opts, onChunk){
    var baud = opts.baud, mark = opts.mark, space = opts.space, stopBits = opts.stopBits, sampleRate = opts.sampleRate, stretch = (opts.stretch==null?DEFAULT_STRETCH:opts.stretch);
    var twoPi = 2*Math.PI; var spbF = (sampleRate/baud)*stretch; var carry=0, phase=0;
    var BLOCK = 16384; var block = new Int16Array(BLOCK); var bi = 0; var total = 0;
    function pushSample(s){ block[bi++] = s; if (bi === block.length){ onChunk(block); block = new Int16Array(BLOCK); bi = 0; } total++; }
    function flush(){ if (bi>0){ onChunk(block.slice(0,bi)); bi = 0; } }
    function emit(freq, bitUnits){
      var wantF = spbF*bitUnits + carry; var want = Math.floor(wantF); carry = wantF - want;
      var inc = twoPi*freq/sampleRate;
      for (var i=0;i<want;i++){
        var f = Math.sin(phase); phase += inc; if (phase>=twoPi) phase -= twoPi;
        var s = (f<=1? (f>=-1? f : -1) : 1) * 32767; pushSample(s|0);
      }
    }
    for (var j=0;j<frames.length;j++){
      var f = frames[j];
      if (f.type==='hold'){ emit(mark, (f.sec||0)*baud); continue; }
      if (f.type==='char'){
        var code=f.code & 0x1F; emit(space,1); for (var k=0;k<5;k++){ var bit=(code>>k)&1; emit(bit?mark:space,1);} emit(mark, stopBits); if (f.guardBits&&f.guardBits>0) emit(mark, f.guardBits);
      }
    }
    emit(mark,2.0); flush(); return total;
  }

  // WAV header builder (16-bit PCM mono)
  function makeWavHeader(sampleRate, sampleCount){
    var dataBytes = (sampleCount * 2) >>> 0; // modulo 2^32 per RIFF
    var riffSize = (36 + dataBytes) >>> 0;
    var buffer = new ArrayBuffer(44); var view = new DataView(buffer);
    function putStr(o,s){ for(var i=0;i<s.length;i++) view.setUint8(o+i, s.charCodeAt(i)); }
    putStr(0,'RIFF'); view.setUint32(4, riffSize, true);
    putStr(8,'WAVE'); putStr(12,'fmt '); view.setUint32(16,16,true);
    view.setUint16(20,1,true); view.setUint16(22,1,true);
    view.setUint32(24,sampleRate,true); view.setUint32(28,sampleRate*2,true);
    view.setUint16(32,2,true); view.setUint16(34,16,true);
    putStr(36,'data'); view.setUint32(40, dataBytes, true);
    return buffer;
  }

  function pad2(n){ return (n<10?'0':'') + n; }

  // ====== Build many WAVs (splitting by minutes / WAV limit) ======
  els.buildBtn.addEventListener('click', function(){
    els.buildBtn.disabled = true; els.downloadWrap.innerHTML = ''; els.player.src = '';
    var n = Math.max(1, Math.min(500, parseInt(els.count.value||'25',10)));
    var gapMin = Math.max(0, parseFloat(els.gap.value||'2'));
    var gapSec = gapMin * 60;

    // solid MARK lead to wake autostarts
    var leadSec = Math.max(0, parseFloat((els.leadSec && els.leadSec.value) || '5'));

    setStatus('Sampling artwork…');
    sampleRandomArt(n).then(function(picks){
      if (!picks.length){ setStatus('No items to process'); els.buildBtn.disabled=false; return; }

      // show previews instead of list
      els.countInfo.textContent = '('+picks.length+')';
      renderPreviews(picks);

      // params
      var baud  = parseFloat(els.baud.value||'45.45');
      var stopB = parseFloat(els.stopBits.value||'1.5');
      var mark  = parseFloat(els.mark.value||'2125');
      var space = parseFloat(els.space.value||'2295');
      var sr = getSampleRate();

      var maxItemMin = Math.max(0, parseFloat(document.getElementById('maxMinItem').value||'0'));
      var maxTotalMin = Math.max(1, parseFloat(document.getElementById('maxMinTotal').value||'1440'));
      var splitMin = Math.max(1, parseFloat(document.getElementById('splitMin').value||'1440'));

      var PER_ITEM_LIMIT = maxItemMin>0 ? Math.floor(sr*60*maxItemMin) : Number.POSITIVE_INFINITY;
      var OVERALL_LIMIT  = Math.floor(sr*60*maxTotalMin);
      var WAV_BYTES_LIMIT = 0xFFFFFFFF - 8; // RIFF safety margin
      var SEG_LIMIT_BY_SPLIT = Math.floor(sr*60*splitMin);
      var SEG_LIMIT_BY_WAV = Math.floor(WAV_BYTES_LIMIT/2);
      var SEG_LIMIT = Math.min(SEG_LIMIT_BY_SPLIT, SEG_LIMIT_BY_WAV);

      // diagnostics
      var stats = { empties:0, tooLongSkipped:0, tooLongStreamed:0, stoppedOverall:false, segments:0 };

      // segment accumulators
      var segChunks = []; // Uint8Array pieces (PCM)
      var segSamples = 0; var segIndex = 1; var overallSamples = 0;
      function openNewSegment(){ segChunks = []; segSamples = 0; }
      function flushSegment(){
        if (segSamples <= 0) return null;
        var header = makeWavHeader(sr, segSamples);
        var blob = new Blob([header].concat(segChunks), { type:'audio/wav' });
        var url = URL.createObjectURL(blob);
        var minutes = (segSamples/sr)/60;
        var a = document.createElement('a');
        a.href = url; a.download = 'rtty_art_seg'+pad2(segIndex)+'.wav';
        a.textContent = 'Download WAV (seg '+segIndex+', ~'+minutes.toFixed(1)+' min)';
        els.downloadWrap.appendChild(a);
        stats.segments++;
        if (segIndex === 1){ els.player.src = url; els.player.load(); }
        segIndex++;
        return url;
      }
      openNewSegment();

      function pushPCM(int16Arr){
        var off = 0;
        while (off < int16Arr.length){
          var room = SEG_LIMIT - segSamples;
          if (room <= 0){ flushSegment(); openNewSegment(); continue; }
          var take = Math.min(room, int16Arr.length - off);
          var view = new Uint8Array(int16Arr.buffer, int16Arr.byteOffset + off*2, take*2);
          var copy = new Uint8Array(take*2); copy.set(view);
          segChunks.push(copy);
          segSamples += take; overallSamples += take; off += take;
          if (overallSamples >= OVERALL_LIMIT){ stats.stoppedOverall = true; return false; }
        }
        return true;
      }

      function emitSilence(samples){
        return new Promise(function(resolve){
          var BLOCK = 16384;
          while (samples > 0){
            var take = Math.min(samples, BLOCK);
            var zeros = new Int16Array(take);
            if (!pushPCM(zeros)) { resolve(false); return; }
            samples -= take;
          }
          resolve(true);
        });
      }

      // estimator (for optional skipping only)
      var spb = (sr / baud) * DEFAULT_STRETCH;
      function estimateSamples(frames){
        var bitUnits = 0;
        for (var a=0;a<frames.length;a++){
          var f = frames[a];
          if (f.type === 'hold') { bitUnits += (f.sec||0) * baud; continue; }
          if (f.type === 'char') { bitUnits += 1 + 5 + stopB + (f.guardBits||0); }
        }
        var est = Math.ceil(bitUnits * spb);
        return (isFinite(est) && est > 0) ? est : 0;
      }

      // sequential processor
      var i = 0, used = 0;
      function processNext(){
        if (i >= picks.length){ done(); return; }
        setStatus('Fetching '+(i+1)+'/'+picks.length+'… '+picks[i].dir+'/'+picks[i].filename);
        (picks[i].normalizedText ? Promise.resolve(picks[i].normalizedText) : fetchArtTextBundled(picks[i].pagePath).then(function(raw){ var t = normalizeText(raw); picks[i].normalizedText = t; return t; }))
        .then(function(text){
          var frames = buildBaudotFramesFromText(text);
          var framesAll = frames;
          if (leadSec > 0){ framesAll = [{ type:'hold', sec: leadSec }].concat(frames); }
          var est = estimateSamples(framesAll);
          if (PER_ITEM_LIMIT !== Number.POSITIVE_INFINITY && est>PER_ITEM_LIMIT){ stats.tooLongSkipped++; i++; processNext(); return; }
          if (est>SEG_LIMIT){ stats.tooLongStreamed++; }
          afskStream(framesAll, { baud:baud, mark:mark, space:space, stopBits:stopB, sampleRate:sr }, function(i16){ pushPCM(i16); });
          used++;
          if ((gapSec>0) && (i<picks.length-1)){
            var gapSamp = Math.max(0, Math.round(sr * gapSec));
            emitSilence(gapSamp).then(function(cont){ if (!cont){ done(); return; } i++; processNext(); });
          } else { i++; processNext(); }
        }).catch(function(){ i++; processNext(); });
      }

      function done(){
        flushSegment();
        if (!used){
          var msg = 'No items added.';
          msg += ' empties:'+stats.empties;
          msg += ' skippedByPerItem:'+stats.tooLongSkipped;
          msg += ' splitItems:'+stats.tooLongStreamed;
          if (stats.stoppedOverall) msg += ' (hit OVERALL minutes cap)';
          msg += '. Adjust limits or count.';
          setStatus(msg);
          els.buildBtn.disabled = false;
          return;
        }
        var totalMin = (overallSamples/sr)/60;
        var note = stats.stoppedOverall ? ' · hit overall cap' : '';
        setStatus('Ready · segments: '+stats.segments+' · items: '+used+' · total ~ '+totalMin.toFixed(1)+' min'+note);
        els.buildBtn.disabled = false;
      }

      processNext();
    });
  });

  // ====== Self-tests ======
  function encodeWav(samples, sampleRate){ // kept for tests only
    var buffer = new ArrayBuffer(44 + samples.length*2); var view = new DataView(buffer);
    function putStr(o,s){ for(var i=0;i<s.length;i++) view.setUint8(o+i, s.charCodeAt(i)); }
    putStr(0,'RIFF'); view.setUint32(4, 36 + samples.length*2, true);
    putStr(8,'WAVE'); putStr(12,'fmt '); view.setUint32(16,16,true);
    view.setUint16(20,1,true); view.setUint16(22,1,true);
    view.setUint32(24,sampleRate,true); view.setUint32(28,sampleRate*2,true);
    view.setUint16(32,2,true); view.setUint16(34,16,true);
    putStr(36,'data'); view.setUint32(40, samples.length*2, true);
    for(var i=0;i<samples.length;i++){
      var s=Math.max(-1,Math.min(1,samples[i]))*32767; view.setInt16(44+i*2, s|0, true);
    }
    return buffer;
  }

  function runTests(){
    var log=[]; var ok=function(m){log.push('✅ '+m);}; var bad=function(m){log.push('❌ '+m);};
    try{
      var tCRLF = normalizeText('A' + CR + LF + 'B');
      if (tCRLF.indexOf('A' + CR + LF + 'B') !== -1) ok('CRLF preserved by normalizeText'); else bad('CRLF not preserved');
      var tSlash = normalizeText('X' + String.fromCharCode(92) + 'Y');
      if (tSlash.indexOf('X/Y')!==-1) ok('Backslash mapped to slash'); else bad('Backslash mapping failed');
      var sample = normalizeText('~@%{}[]|^*');
      var expect = '-AO()()/-X';
      if (sample === expect) ok('Replacement map correct'); else bad('Replacement map wrong: ' + sample + ' != ' + expect);
      var allowed = new Set((printableSet + CR + LF).split(''));
      if ([].every.call(sample, function(ch){ return allowed.has(ch); })) ok('normalizeText emits only allowed chars'); else bad('normalizeText emitted disallowed chars');
      if (BAUDOT_TABLE.LTRS['A']===3) ok('BAUDOT LTRS A'); else bad('BAUDOT LTRS A wrong');
      if ('1' in BAUDOT_TABLE.FIGS) ok('BAUDOT FIGS 1 present'); else bad('BAUDOT FIGS 1 missing');
      var frames = buildBaudotFramesFromText('HI' + CR + LF);
      if (frames.length>=10) ok('Frames built'); else bad('Frames too short');
      var fNums = buildBaudotFramesFromText('12' + CR + LF);
      var sawFIGS = false; for (var z=0; z<fNums.length; z++){ if (fNums[z].type==='char' && fNums[z].code===FIGS){ sawFIGS = true; break; } }
      if (sawFIGS) ok('FIGS shift emitted for digits'); else bad('FIGS shift not emitted for digits');
      var sig = (function(){ var arr = []; var twoPi=2*Math.PI; var ph=0; var inc=twoPi*100/48000; for(var i=0;i<1000;i++){ arr.push(Math.sin(ph)); ph+=inc; } return arr; })();
      var wav = encodeWav(new Float32Array(sig), 48000);
      var dv = new DataView(wav);
      var tag = String.fromCharCode(dv.getUint8(0),dv.getUint8(1),dv.getUint8(2),dv.getUint8(3));
      var wave = String.fromCharCode(dv.getUint8(8),dv.getUint8(9),dv.getUint8(10),dv.getUint8(11));
      if (tag==='RIFF' && wave==='WAVE') ok('WAV header OK'); else bad('WAV header incorrect');
      var crOnly = 'LINE1' + CR + 'LINE2' + CR; var crlf = normalizeCRLF(crOnly);
      if (crlf.slice(-2)===CR+LF) ok('normalizeCRLF converts CR to CRLF'); else bad('normalizeCRLF did not convert CR to CRLF');
      var wav0 = encodeWav(new Float32Array(), 48000); if (wav0.byteLength === 44) ok('Zero-length WAV header is 44 bytes'); else bad('Zero-length WAV header wrong size');
      var keep = 'A' + CR + LF + 'B'; if (normalizeCRLF(keep) === keep) ok('normalizeCRLF leaves CRLF intact'); else bad('normalizeCRLF altered existing CRLF');
      var unknown = normalizeText('🙂'); if (unknown === ' ') ok('Unknown glyphs map to space'); else bad('Unknown glyph not mapped to space');
      var swOk = (!isSfwAllowed('ARTWORK-04/000') && !isSfwAllowed('ARTWORK-07/000') && !isSfwAllowed('ARTWORK-08/000') && isSfwAllowed('ARTWORK-03/123'));
      if (swOk) ok('SFW filter excludes 04,07,08 and NSFW List'); else bad('SFW filter failed');
      // Art set filter test
      var prevSet = els.artSet ? els.artSet.value : 'all';
      if (els.artSet){ els.artSet.value = 'cartoons'; }
      if (isInSelectedSet('ARTWORK-01/000') && !isInSelectedSet('ARTWORK-02/000')) ok('Art set filter works'); else bad('Art set filter broken');
      if (els.artSet){ els.artSet.value = prevSet; }
      // NSFW overrides test
      nsfwOverrides.map['ARTWORK-01/123'] = 1;
      if (!isSfwAllowed('ARTWORK-01/123')) ok('NSFW overrides honored'); else bad('NSFW overrides ignored');
      delete nsfwOverrides.map['ARTWORK-01/123'];
      var fmtTag = String.fromCharCode(dv.getUint8(12),dv.getUint8(13),dv.getUint8(14),dv.getUint8(15));
      var dataTag = String.fromCharCode(dv.getUint8(36),dv.getUint8(37),dv.getUint8(38),dv.getUint8(39));
      if (fmtTag==='fmt ' && dataTag==='data') ok('fmt/data chunks present'); else bad('fmt/data chunks missing');
      var h = makeWavHeader(48000, 48000*60);
      if (new DataView(h).getUint32(40, true) === 48000*60*2) ok('makeWavHeader data size correct'); else bad('makeWavHeader size wrong');
      var chunks = 0; var framesTest = buildBaudotFramesFromText('TEST' + CR + LF);
      afskStream(framesTest, { baud:45.45, mark:2125, space:2295, stopBits:1.5, sampleRate:48000 }, function(){ chunks++; });
      if (chunks>0) ok('afskStream emitted chunks'); else bad('afskStream emitted no chunks');
      var srTest = getSampleRate(); if (srTest>=8000 && srTest<=192000) ok('getSampleRate sane: '+srTest); else bad('getSampleRate out of range: '+srTest);
      // CR before LF injection test
      var onlyLF = buildBaudotFramesFromText('X' + LF + 'Y');
      var hasCRBeforeLF = false;
      for (var t=0;t<onlyLF.length-1;t++){
        if (onlyLF[t].type==='char' && onlyLF[t].code===BAUDOT_TABLE.LTRS[CR] && onlyLF[t+1].type==='char' && onlyLF[t+1].code===BAUDOT_TABLE.LTRS[LF]){ hasCRBeforeLF = true; break; }
      }
      if (hasCRBeforeLF) ok('CR injected before LF'); else bad('CR not injected before LF');
      // Hold-mark should generate about 1 second of samples at 48k
      var nHold = afskStream([{type:'hold', sec:1}], { baud:45.45, mark:2125, space:2295, stopBits:1.5, sampleRate:48000 }, function(){});
      if (nHold > 44000 && nHold < 52000) ok('Hold-mark ~1s produced '+nHold+' samples'); else bad('Hold-mark length off: '+nHold);
      // parseNsfwList newline and JSON tests
      var mapTxt = parseNsfwList('ARTWORK-01/123\nARTWORK-02/045\n');
      if (mapTxt['ARTWORK-01/123'] && mapTxt['ARTWORK-02/045']) ok('parseNsfwList handles newline list'); else bad('parseNsfwList newline parse failed');
      var mapJson = parseNsfwList('["ARTWORK-03/001","ARTWORK-05/222"]');
      if (mapJson['ARTWORK-03/001'] && mapJson['ARTWORK-05/222']) ok('parseNsfwList handles JSON array'); else bad('parseNsfwList JSON parse failed');
    }catch(e){ bad('Exception in tests: '+(e.message||e)); }
    els.testLog.style.display='block';
    els.testLog.textContent = log.join('\n');
  }
  els.testBtn.addEventListener('click', runTests);
})();
</script>
</body>
</html>
